<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>沖繩美食地圖 | Okinawa Food Guide</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">

    <!-- PWA Manifest -->
    <link rel="manifest"
        href='data:application/json;charset=utf-8,%7B%22name%22%3A%22%E6%B2%96%E7%B9%A9%E7%BE%8E%E9%A3%9F%E5%9C%B0%E5%9C%96%22%2C%22short_name%22%3A%22%E6%B2%96%E7%B9%A9%E7%BE%8E%E9%A3%9F%22%2C%22start_url%22%3A%22.%2Findex.html%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%23000000%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F662%2F662646.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <!-- Leaflet & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Apple HIG / iOS System Colors + Reference Theme (Yellow) */
            --bg-color: #ffffff;
            --surface-color: rgba(255, 255, 255, 0.95);
            --surface-solid: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8E8E93;

            /* Reference Theme Colors */
            --accent-color: #FCCE02;
            /* Bright Yellow */
            --accent-text: #000000;
            /* Black text on Yellow */

            --highlight-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;

            --border-radius: 16px;
            --card-radius: 24px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-float: 0 8px 32px rgba(0, 0, 0, 0.12);
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --surface-color: rgba(28, 28, 30, 0.85);
            --surface-solid: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #98989D;
            --accent-color: #FFD60A;
            --highlight-color: #FF453A;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-float: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: var(--font-main);
            /* Enforce system font everywhere */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #f2f2f7;
            /* iOS grouped background */
        }

        [data-theme="dark"] #map {
            background: #000000;
        }

        /* --- UI Overlay --- */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: var(--safe-bottom);
            /* Safe area */
        }

        /* Top Bar */
        .top-shelf {
            pointer-events: auto;
            padding-top: max(var(--safe-top), 16px);
            margin: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-bar-wrap {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* Safari support */
            border-radius: 12px;
            /* iOS Search Bar radius */
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            padding: 8px 12px;
            max-width: 480px;
            /* Limit width on iPad/Desktop */
            transition: all 0.2s ease;
        }

        .search-bar-wrap:focus-within {
            box-shadow: var(--shadow-float);
            transform: scale(1.01);
        }

        .search-icon {
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            margin-right: 8px;
        }

        #search-input {
            border: none;
            background: transparent;
            flex: 1;
            padding: 4px 0;
            font-size: 17px;
            /* iOS Body size */
            font-weight: 400;
            color: var(--text-primary);
        }

        #search-input:focus {
            outline: none;
        }

        #search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Filter Pills */
        .filter-scroller {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 2px;
            padding-bottom: 8px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .filter-scroller::-webkit-scrollbar {
            display: none;
        }

        .filter-pill {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 18px;
            /* Classic iOS pill */
            font-size: 15px;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 0.5px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .filter-pill {
            border: 0.5px solid rgba(255, 255, 255, 0.1);
        }

        .filter-pill.active {
            background: var(--accent-color);
            color: var(--accent-text);
            border-color: transparent;
            font-weight: 700;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(252, 206, 2, 0.4);
            /* Yellow Glow */
        }

        /* Floating Actions */
        .fab-stack {
            position: absolute;
            bottom: calc(var(--safe-bottom) + 20px);
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            pointer-events: auto;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--text-primary);
            /* Default icon color */
            border: none;
            box-shadow: var(--shadow-float);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .fab:active {
            transform: scale(0.92);
            filter: brightness(0.95);
        }

        .fab.primary {
            background: var(--accent-color);
            color: var(--accent-text);
        }

        /* Custom Popup Style */
        .leaflet-popup-content-wrapper {
            border-radius: var(--card-radius);
            padding: 0;
            background: var(--surface-solid);
            box-shadow: var(--shadow-float);
            color: var(--text-primary);
            overflow: hidden;
        }

        .leaflet-popup-tip {
            background: var(--surface-solid);
        }

        .leaflet-container a.leaflet-popup-close-button {
            padding: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            top: 4px;
            right: 4px;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .custom-popup-content {
            width: 280px !important;
        }

        .popup-hero {
            height: 120px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            /* Default Gradient */
            display: flex;
            align-items: flex-end;
            padding: 16px;
            box-sizing: border-box;
            position: relative;
        }

        /* iOS-like Gradients */
        .popup-hero[data-price="High"] {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
        }

        /* Red-ish */
        .popup-hero[data-price="Low"] {
            background: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%);
        }

        /* Green-ish */

        .popup-title {
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-size: 20px;
            font-weight: 700;
            line-height: 1.1;
            z-index: 2;
        }

        .popup-details {
            padding: 16px;
        }

        .tag-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 100px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(142, 142, 147, 0.1);
            color: var(--text-secondary);
            line-height: 1;
        }

        .tag.price {
            color: var(--highlight-color);
            background: rgba(255, 59, 48, 0.1);
        }

        .tag.dist {
            color: var(--accent-color);
            background: rgba(0, 122, 255, 0.1);
        }

        .desc-text {
            font-size: 15px;
            line-height: 1.4;
            color: var(--text-primary);
            margin-bottom: 20px;
            opacity: 0.85;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .action-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: var(--accent-color);
            /* GO! Button Yellow */
            color: var(--accent-text);
            border-radius: 30px;
            /* Pill shape for button */
            text-decoration: none;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: opacity 0.2s, transform 0.1s;
        }

        .action-btn:active {
            opacity: 0.9;
            transform: scale(0.98);
        }


        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .loader-dot {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 0, 0, 0.05);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Marker Labels */
        .map-label {
            background: var(--surface-color);
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
        }

        [data-theme="dark"] .map-label {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaflet-circle-marker {
            transition: r 0.3s ease;
        }
    </style>
</head>

<body>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="loader-dot"></div>
        <p style="margin-top:20px; font-weight:500; opacity:0.6;">Loading Map...</p>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- UI Overlay -->
    <div class="ui-overlay">

        <!-- Top Controls -->
        <div class="top-shelf">
            <div class="search-bar-wrap">
                <div class="search-icon"><i class="fas fa-search"></i></div>
                <input type="text" id="search-input" placeholder="Find Ramen, Sushi..." autocomplete="off">
            </div>

            <div class="filter-scroller">
                <div class="filter-pill active" data-filter="all">全部</div>
                <div class="filter-pill" data-filter="北部">北部</div>
                <div class="filter-pill" data-filter="中部">中部</div>
                <div class="filter-pill" data-filter="南部">南部</div>
            </div>
        </div>

        <!-- FABs -->
        <div class="fab-stack">
            <button class="fab" id="btn-theme"><i class="fas fa-moon"></i></button>
            <button class="fab primary" id="btn-locate"><i class="fas fa-location-arrow"></i></button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 1. CONFIG & SHIMS ---

        // Correct JSONP URL with responseHandler
        const SHEET_JSONP_URL = 'https://docs.google.com/spreadsheets/d/1igtQX_K3H24gSYxyh6zeridz4pbYVRTCJYTpCdCRnF4/gviz/tq?tqx=responseHandler:googleSheetCallback';

        // Shim to catch default google callback if parameters fail
        window.google = window.google || {};
        window.google.visualization = window.google.visualization || {};
        window.google.visualization.Query = window.google.visualization.Query || {};
        window.google.visualization.Query.setResponse = function (json) {
            handleData(json);
        };

        // --- 2. APP LOGIC ---

        const map = L.map('map', { zoomControl: false, tap: false }).setView([26.4, 127.9], 9);
        // L.control.zoom({ position: 'bottomright' }).addTo(map); // Optional: Zoom controls

        const tiles = {
            light: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            dark: 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png'
        };
        let tileLayer = L.tileLayer(tiles.light, {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 20
        }).addTo(map);

        let restaurantsData = [];
        let markers = [];
        let userLat = null, userLng = null, userMarker = null;

        function initApp() {
            // Inject Script with Cache Buster
            const script = document.createElement('script');
            script.src = SHEET_JSONP_URL + '&_=' + Date.now();
            script.onerror = () => showError("Connection Failed. Blocked by Browser or Network.");
            document.body.appendChild(script);

            // Geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; },
                    (err) => console.log("Loc error", err),
                    { timeout: 5000 }
                );
            }
        }

        // Global Callback
        window.googleSheetCallback = function (json) {
            handleData(json);
        };

        function handleData(json) {
            if (!json || !json.table || !json.table.rows) {
                showError("Invalid Data Format");
                return;
            }

            // Dynamic Column Mapping
            const cols = json.table.cols;
            const colMap = {};
            cols.forEach((col, index) => {
                if (col && col.label) {
                    colMap[col.label.toLowerCase().trim()] = index;
                }
            });

            // Helper to get index by multiple possible names
            const getIdx = (...names) => {
                for (let n of names) {
                    if (colMap[n.toLowerCase()] !== undefined) return colMap[n.toLowerCase()];
                }
                return -1;
            };

            const idx = {
                region: getIdx('region', '地區'),
                name: getIdx('name', '店名'),
                category: getIdx('category', '分類'),
                price: getIdx('price', '價格'),
                mustOrder: getIdx('must_order', '必點', 'recommended'),
                desc: getIdx('description', '簡介', 'notes', '備註'),
                addr: getIdx('address', '地址'),
                link: getIdx('gmap_link', '連結', 'google map'),
                lat: getIdx('lat', '緯度'),
                lng: getIdx('lng', '經度')
            };

            const rows = json.table.rows;
            restaurantsData = rows.map(r => {
                const c = r.c;
                if (!c) return null;
                const v = (i) => (i >= 0 && c[i] && c[i].v !== null) ? String(c[i].v).trim() : "";

                // Content-based heuristic for Lat/Lng
                // Okinawa is roughly Lat 26.x, Lng 127.x
                let lat = null;
                let lng = null;

                // Scan all columns for potential coordinates
                c.forEach(cell => {
                    if (cell && typeof cell.v === 'number') {
                        const val = cell.v;
                        if (val > 24 && val < 28) lat = val;
                        if (val > 126 && val < 130) lng = val;
                    }
                });

                // Fallback: If still null, try mapped indices but check value range
                if (lat === null) {
                    const val = (idx.lat >= 0 && c[idx.lat]) ? parseFloat(c[idx.lat].v) : null;
                    if (val && val > 20 && val < 50) lat = val;
                }
                if (lng === null) {
                    const val = (idx.lng >= 0 && c[idx.lng]) ? parseFloat(c[idx.lng].v) : null;
                    if (val && val > 120 && val < 150) lng = val;
                }

                // Name is essential
                const name = v(idx.name);
                if (!name || !lat || !lng) return null;

                // Validate Text Fields
                let address = v(idx.addr);
                let link = v(idx.link);
                let desc = v(idx.desc) || v(idx.notes); // Combined fallback

                // Clean up merged text fields (simple heuristics)
                // If address is essentially the same as description or name, ignore it
                if (address === desc || address === name) address = "";

                // If address looks like description (no digits/keywords), merge to desc
                if (address && !/[0-9市區町號]/.test(address) && address.length > 6) {
                    // check if desc already contains it to avoid duplication
                    if (!desc.includes(address)) desc += (" " + address);
                    address = "";
                }

                // If link is not http, it's probably text
                if (link && !link.startsWith('http')) {
                    if (!desc.includes(link)) desc += (" " + link);
                    link = "";
                }

                return {
                    region: v(idx.region),
                    name: name,
                    category: v(idx.category),
                    price: v(idx.price),
                    mustOrder: v(idx.mustOrder),
                    description: desc,
                    address: address,
                    gmapLink: link,
                    lat: lat,
                    lng: lng
                };
            }).filter(i => i !== null);

            if (restaurantsData.length === 0) {
                showError("No valid data found.");
                return;
            }

            renderMarkers(restaurantsData);

            // Hide Loader
            const loader = document.getElementById('loading');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            }
        }

        function showError(msg) {
            console.error(msg);
            document.getElementById('loading').innerHTML = `
                <div style="text-align:center; padding: 24px;">
                   <i class="fas fa-bug" style="font-size:48px; margin-bottom:16px;"></i>
                   <p>${msg}</p>
                   <button onclick="location.reload()" style="margin-top:16px; padding:8px 16px; cursor:pointer;">Retry</button>
                </div>
            `;
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(item => {
                const color = getMarkerColor(item.price);
                const isDark = document.body.getAttribute('data-theme') === 'dark';

                // Color tweaks for dark mode contrast
                const finalColor = (isDark && color === '#1e3b79') ? '#64b5f6' : color;

                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 8,
                    fillColor: finalColor,
                    color: "#ffffff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 1
                });

                marker.bindTooltip(item.name, {
                    permanent: true, direction: 'top',
                    className: 'map-label', offset: [0, -8]
                });

                marker.bindPopup(() => createPopup(item));
                marker.addTo(map);
                markers.push(marker);
            });

            if (data.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }

        function createPopup(item) {
            const gLink = item.gmapLink || `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}&destination_place_id=${encodeURIComponent(item.name)}`;

            const dist = (userLat && userLng)
                ? calculateDistance(userLat, userLng, item.lat, item.lng) + " km"
                : "";

            return `
                <div class="custom-popup-content">
                    <div class="popup-hero" data-price="${item.price}">
                        <div class="popup-title">${item.name}</div>
                    </div>
                    <div class="popup-details">
                        <div class="tag-row">
                            <span class="tag">${item.category}</span>
                            <span class="tag price">${item.price === 'Low' ? '$' : item.price === 'High' ? '$$$' : '$$'}</span>
                            ${dist ? `<span class="tag dist"><i class="fas fa-walking"></i> ${dist}</span>` : ''}
                        </div>
                        <p class="desc-text">${item.description || "No description available."}</p>
                        ${item.mustOrder ? `<div style="font-size:13px; color:var(--highlight-color); margin-bottom:8px; font-weight:500;"><i class="fas fa-thumbs-up"></i> 必點：${item.mustOrder}</div>` : ''}
                        ${item.address ? `<div style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;"><i class="fas fa-map-pin"></i> ${item.address}</div>` : ''}
                        <a href="${gLink}" target="_blank" class="action-btn">
                            Navigate
                        </a>
                    </div>
                </div>
            `;
        }

        // --- UTILS ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(1);
        }
        function getMarkerColor(price) {
            const p = (price || "").toLowerCase().trim();
            if (p === 'low') return "#34C759"; // Green
            if (p === 'high') return "#FF3B30"; // Red
            return "#FCCE02"; // Yellow (Default/Medium)
        }   // --- INTERACTIONS ---

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const activeRegion = document.querySelector('.filter-pill.active').dataset.filter;

            const filtered = restaurantsData.filter(d => {
                const matchSearch = d.name.toLowerCase().includes(val) || d.category.toLowerCase().includes(val);
                const matchRegion = activeRegion === 'all' || d.region === activeRegion;
                return matchSearch && matchRegion;
            });
            renderMarkers(filtered);
            if (filtered.length === 1) map.panTo([filtered[0].lat, filtered[0].lng]);
        });

        // Filter Pills
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');

                const region = pill.dataset.filter;
                // Reuse search logic to keep consistence
                const searchVal = document.getElementById('search-input').value.toLowerCase();

                const filtered = restaurantsData.filter(d => {
                    const matchRegion = region === 'all' || d.region === region;
                    const matchSearch = !searchVal || d.name.toLowerCase().includes(searchVal);
                    return matchRegion && matchSearch;
                });
                renderMarkers(filtered);
            });
        });

        // Toggle Theme
        const btnTheme = document.getElementById('btn-theme');
        btnTheme.addEventListener('click', () => {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', next);

            if (next === 'dark') {
                btnTheme.innerHTML = '<i class="fas fa-sun"></i>';
                tileLayer.setUrl(tiles.dark);
            } else {
                btnTheme.innerHTML = '<i class="fas fa-moon"></i>';
                tileLayer.setUrl(tiles.light);
            }
            // Re-render markers for color update
            renderMarkers(restaurantsData.length ? restaurantsData : []);
        });

        // Locate User
        document.getElementById('btn-locate').addEventListener('click', () => {
            if (!navigator.geolocation) return alert("Geolocation not supported");
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude, accuracy } = pos.coords;
                userLat = latitude; userLng = longitude;

                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([latitude, longitude]).addTo(map);

                map.flyTo([latitude, longitude], 13);
                // Refresh popups to show distance
                renderMarkers(restaurantsData);
            });
        });

        initApp();
    </script>
</body>

</html>